name: ðŸš€ Build & Distribute

run-name: "ðŸ³ ${{ github.actor }} is building & pushing a new image! ðŸ› ï¸"

on:
  workflow_dispatch:
  workflow_call:
  push:
    paths:
      - src/charge/**
      - docker/core/Dockerfile
    tags:
      - release/**

jobs:
  package:
    runs-on:
      group: on-prem

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone of current branch.
          fetch-tags: false
          ref: ${{ github.ref }}
          sparse-checkout: |
            docker/Dockerfile
            nginx.conf
            VERSION
          sparse-checkout-cone-mode: false

      - name: ðŸ“Œ Extract application details
        id: details
        run: echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: ðŸ”‘ Authenticate to Container Registry
        run: |
          docker login harbor.peinser.com \
            -u '${{ secrets.OCI_REGISTRY_HARBOR_LOGIN }}' \
            -p '${{ secrets.OCI_REGISTRY_HARBOR_SECRET }}'

      - name: ðŸ“¦ Pull prerequisites image (if they exist)
        run: |
          version=${{ steps.details.outputs.version }}
          docker pull harbor.peinser.com/library/peppol-directory-cache:$version || true

      - name: ðŸ—ï¸ Build & Push Image
        run: |
          version=${{ steps.details.outputs.version }}
          echo "âš™ï¸ Building image..."
          docker build \
            -f docker/Dockerfile \
            -t harbor.peinser.com/library/peppol-directory-cache:$version .

          echo "ðŸ“¤ Pushing image to registry..."
          docker push harbor.peinser.com/library/peppol-directory-cache:$version

          echo "âœ… Successfully pushed image: harbor.peinser.com/library/peppol-directory-cache:$version"
          echo "ðŸ“¦ Published: \`harbor.peinser.com/library/peppol-directory-cache:$version\`" >> $GITHUB_STEP_SUMMARY