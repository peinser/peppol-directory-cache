http {
    proxy_cache_path /workspace/.dev/var/cache/nginx levels=1:2 keys_zone=peppol_cache:20m max_size=1g use_temp_path=off;

    # Custom log format
    log_format custom '$remote_addr - $remote_user [$time_local] '
                     '"$request" $status $body_bytes_sent '
                     '"$http_referer" "$http_user_agent" '
                     'Cache-Status: $upstream_cache_status '
                     'Request-URI: $request_uri '
                     'Cache-Control: $http_cache_control';

    access_log /workspace/.dev/logs/access.log custom;
    error_log /workspace/.dev/logs/error.log debug;

    gzip on;
    gzip_types application/json;
    gzip_min_length 256;
    gzip_comp_level 6;

    server {
        listen 8000;

        # Normalized cache key (without scheme)
        set_by_lua_block $normalized_cache_key {
            local function sort_query_params(query)
                if not query or query == "" then
                    return ""
                end
                local params = {}
                for k, v in string.gmatch(query, "([^&=]+)=([^&]*)") do
                    table.insert(params, k .. "=" .. v)
                end
                table.sort(params)
                return table.concat(params, "&")
            end
            local uri = ngx.var.request_uri
            local path = uri:match("^[^?]*") or uri
            local query = uri:match("%?(.*)$") or ""
            local sorted_query = sort_query_params(query)
            return path .. (sorted_query ~= "" and "?" .. sorted_query or "")
        }

        # Cache settings
        proxy_cache peppol_cache;
        proxy_cache_key $normalized_cache_key;
        proxy_cache_valid any 7d; # Cache all responses for 7 days
        proxy_ignore_headers Cache-Control Expires; # Ignore backend cache headers

        location / {
            proxy_pass https://directory.peppol.eu/search/1.0/json;
            # proxy_set_header Host $host;
            # proxy_set_header X-Real-IP $remote_addr;
            # proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # proxy_set_header X-Forwarded-Proto $scheme;
            add_header X-Cache-Status $upstream_cache_status;
        }
    }
}

events {
    worker_connections 1024;
}