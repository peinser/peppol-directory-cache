pid /tmp/nginx.pid;

http {
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=peppol_cache:128m max_size=8g;

    log_format custom '$remote_addr - $remote_user [$time_local] '
                     '"$request" $status $body_bytes_sent '
                     '"$http_referer" "$http_user_agent" '
                     'Cache-Status: $upstream_cache_status '
                     'Request-URI: $request_uri '
                     'Cache-Control: $http_cache_control';

    access_log /dev/stdout custom;
    error_log /dev/stderr debug;

    gzip on;
    gzip_types application/json;
    gzip_min_length 256;
    gzip_comp_level 6;

    server {
        listen 8000;

        # Normalized cache key (without scheme)
        set_by_lua_block $normalized_cache_key {
            local function sort_query_params(query)
                if not query or query == "" then
                    return ""
                end
                local params = {}
                for k, v in string.gmatch(query, "([^&=]+)=([^&]*)") do
                    table.insert(params, k .. "=" .. v)
                end
                table.sort(params)
                return table.concat(params, "&")
            end
            local uri = ngx.var.request_uri
            local path = uri:match("^[^?]*") or uri
            local query = uri:match("%?(.*)$") or ""
            local sorted_query = sort_query_params(query)
            return path .. (sorted_query ~= "" and "?" .. sorted_query or "")
        }

        proxy_cache peppol_cache;
        proxy_cache_key $normalized_cache_key;
        proxy_cache_valid 200 365d;
        proxy_ignore_headers Cache-Control Expires Vary Set-Cookie;
        proxy_cache_methods GET HEAD;
        proxy_hide_header Set-Cookie;
        proxy_set_header Authorization "";
        proxy_cache_lock on; # Prevent concurrent upstream requests
        proxy_cache_use_stale error timeout invalid_header updating; # Serve stale cache if upstream fails
        proxy_cache_bypass $http_pragma; # Allow manual bypass for debugging

        location / {
            proxy_pass https://directory.peppol.eu/search/1.0/json;
            add_header X-Cache-Status $upstream_cache_status;
            add_header X-Cache-Key $normalized_cache_key;
        }

        location /favicon.ico {
            return 404;  # Annoying if Peppol directory is overloaded.
        }

        location /.info/healthz {
            return 200 'All Gucci';
            add_header Content-Type text/plain;
        }
    }
}

events {
    worker_connections 1024;
}