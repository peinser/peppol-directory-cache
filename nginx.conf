pid /tmp/nginx.pid;

http {
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=peppol_cache:1gl max_size=8g;

    log_format custom '$remote_addr - $remote_user [$time_local] '
                     '"$request" $status $body_bytes_sent '
                     '"$http_referer" "$http_user_agent" '
                     'Cache-Status: $upstream_cache_status '
                     'Request-URI: $request_uri '
                     'Cache-Control: $http_cache_control';

    access_log /dev/stdout custom;
    error_log /dev/stderr debug;

    gzip on;
    gzip_types application/json;
    gzip_min_length 256;
    gzip_comp_level 6;

    limit_req_zone $server_name zone=peppol_ratelimit:10m rate=3r/s;

    server {
        listen 8000;

        # Normalized cache key (without scheme)
        set_by_lua_block $normalized_cache_key {
            local function sort_query_params(query)
                if not query or query == "" then
                    return ""
                end
                local params = {}
                for k, v in string.gmatch(query, "([^&=]+)=([^&]*)") do
                    table.insert(params, k .. "=" .. v)
                end
                table.sort(params)
                return table.concat(params, "&")
            end
            local uri = ngx.var.request_uri
            local path = uri:match("^[^?]*") or uri
            local query = uri:match("%?(.*)$") or ""
            local sorted_query = sort_query_params(query)
            return path .. (sorted_query ~= "" and "?" .. sorted_query or "")
        }

        proxy_cache peppol_cache;
        proxy_cache_key $normalized_cache_key;
        proxy_cache_valid 200 365d;
        proxy_ignore_headers Cache-Control Expires Vary Set-Cookie;
        proxy_cache_methods GET HEAD;
        proxy_hide_header Set-Cookie;
        proxy_hide_header Cache-Control;
        proxy_hide_header Expires;
        proxy_hide_header Pragma;
        proxy_set_header Authorization "";
        # proxy_cache_lock on; # Prevent concurrent upstream requests
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
        proxy_cache_bypass $http_pragma; # Allow manual bypass for debugging

        # TODO The page shouldn't be cached of the number of matches is 0.
        # Response looks something like this:
        # {
        #   "version": "1.0",
        #   "total-result-count": 0,
        #   "used-result-count": 0,
        #   "result-page-index": 0,
        #   "result-page-count": 20,
        #   "first-result-index": 0,
        #   "last-result-index": -1,
        #   "query-terms": "q=079962fdsfdsfsd0488&q=BE",
        #   "creation-dt": "2025-10-06T07:10:01.125Z",
        #   "matches": []
        # }

        location / {
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;

            limit_req zone=peppol_ratelimit burst=10; # This will queue 10 requests.
            proxy_pass https://directory.peppol.eu/search/1.0/json;
            add_header X-Cache-Status $upstream_cache_status;
            add_header X-Cache-Key $normalized_cache_key;
        }

        location /favicon.ico {
            return 404;  # Annoying if Peppol directory is overloaded.
        }

        location /.info/healthz {
            return 200 'All Gucci';
            add_header Content-Type text/plain;
        }
    }
}

events {
    worker_connections 1024;
}